# stock_data_process_flat_pathlib.py
# ç›®çš„ï¼šè®€å–å¤šå€‹åŸå§‹ CSVï¼ˆå¯èƒ½ç‚ºæ°‘åœ‹å¹´æˆ–è¥¿å…ƒå¹´ï¼‰ï¼Œæ¸…ç†ã€åˆä½µã€è¨ˆç®— MA5/10/20ï¼Œè¼¸å‡º big5 ç·¨ç¢¼ CSVï¼Œä¸¦ç”¢ç”Ÿè¿‘90å¤© K ç·šåœ–ã€‚
# é¢¨æ ¼ï¼šå®Œå…¨ Pathlibã€å‡½å¼å–®ä¸€åŠŸèƒ½ã€é¿å… lambda
# é¡è‰²ï¼šä¸Šæ¼²ç´…ã€ä¸‹è·Œç¶ ï¼›MA5 ç´«ã€MA10 æ·±ç¶ ã€MA20 é»ƒ

import pandas as pd
from pathlib import Path
import re
from datetime import datetime, timedelta
import mplfinance as mpf
import matplotlib.pyplot as plt

# -----------------------------
# è¨­å®š
# -----------------------------
STOCK_CODE = "2330"
STOCK_NAME = "å°ç©é›»"

BASE_RAW_DIR = Path(r"D:\Python_repo\python\Jason_Stock_Analyzer\datas\raw\1_STOCK_DAY")
INPUT_DIR = BASE_RAW_DIR / STOCK_CODE
OUTPUT_DIR = BASE_RAW_DIR.parent
OUTPUT_FILE = f"{STOCK_NAME}_stocks_data.csv"
OUTPUT_PATH = OUTPUT_DIR / OUTPUT_FILE

ENCODINGS_TO_TRY = ['utf-8-sig', 'big5', 'utf-8', 'cp950']
PRICE_COLS = ['é–‹ç›¤åƒ¹', 'æœ€é«˜åƒ¹', 'æœ€ä½åƒ¹', 'æ”¶ç›¤åƒ¹']
ALL_REQUIRED_COLS = ['æ—¥æœŸ'] + PRICE_COLS

# -----------------------------
# å‡½å¼ï¼šæ—¥æœŸè½‰æ›
# -----------------------------
def convert_roc_to_gregorian(date_str):
    if pd.isna(date_str) or not isinstance(date_str, str):
        return None
    s = date_str.strip()
    trans_table = str.maketrans('ï¼Œã€‚ï¼ï¼ï¼šï¼', ',./-:.')
    s = s.translate(trans_table)
    s = s.replace('å¹´','/').replace('æœˆ','/').replace('æ—¥','')
    m = re.search(r'(\d{2,4})\D+(\d{1,2})\D+(\d{1,2})', s)
    if not m:
        return None
    year, month, day = int(m.group(1)), int(m.group(2)), int(m.group(3))
    if year <= 1911:
        year += 1911
    try:
        d = datetime(year, month, day)
        return f"{d.year}/{d.month:02d}/{d.day:02d}"
    except Exception:
        return None

# -----------------------------
# å‡½å¼ï¼šå¤šç·¨ç¢¼è®€ CSV
# -----------------------------
def try_read_csv(filepath: Path, encodings):
    for enc in encodings:
        try:
            df = pd.read_csv(filepath, encoding=enc)
            return df, enc
        except UnicodeDecodeError:
            continue
        except Exception as e:
            print(f"âŒ {filepath.name} ä½¿ç”¨ {enc} ç™¼ç”ŸéŒ¯èª¤: {e}")
            return None, None
    print(f"âš ï¸ {filepath.name} ç„¡æ³•è®€å–")
    return None, None

# -----------------------------
# å‡½å¼ï¼šæ¸…ç† DataFrame
# -----------------------------
def clean_dataframe(df):
    df.columns = df.columns.str.strip()
    for col in ALL_REQUIRED_COLS:
        if col not in df.columns:
            raise KeyError(f"ç¼ºæ¬„ä½: {col}")
    # æ—¥æœŸè½‰æ›
    date_list = []
    for d in df['æ—¥æœŸ'].astype(str):
        date_list.append(convert_roc_to_gregorian(d))
    df['æ—¥æœŸ'] = date_list
    df = df.dropna(subset=['æ—¥æœŸ']).copy()
    df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'], errors='coerce')
    df = df.dropna(subset=['æ—¥æœŸ']).copy()
    # åš´æ ¼æ¸…ç†åƒ¹æ ¼æ¬„
    for col in PRICE_COLS:
        df[col] = df[col].astype(str).str.replace('ï¼Œ',',').str.replace('ï¼','-')
        df[col] = df[col].astype(str).str.replace(r'[^0-9\.\-]','', regex=True)
        df[col] = pd.to_numeric(df[col], errors='coerce')
    df = df.dropna(subset=ALL_REQUIRED_COLS)
    return df[ALL_REQUIRED_COLS].copy()

# -----------------------------
# å‡½å¼ï¼šç–ŠåŠ  MA ç·šä¸¦åŠ åœ–ä¾‹
# -----------------------------
def add_ma_lines_and_legend(ax, df_plot, ma_colors, legend_loc='upper left', fontsize=10):
    for ma, color in ma_colors.items():
        if ma in df_plot.columns:
            ax.plot(df_plot.index, df_plot[ma], color=color, linewidth=1.5, label=ma)
    ax.legend(loc=legend_loc, fontsize=fontsize, frameon=True, shadow=True)

# -----------------------------
# ä¸»ç¨‹å¼
# -----------------------------
def main():
    if not INPUT_DIR.exists():
        print(f"âŒ è³‡æ–™å¤¾ä¸å­˜åœ¨: {INPUT_DIR}")
        return
    files = sorted(INPUT_DIR.glob("*.csv"))
    if not files:
        print("âš ï¸ æ²’æœ‰ CSV æª”")
        return

    all_dfs = []
    for f in files:
        print(f"\n--- è™•ç† {f.name} ---")
        df_raw, enc = try_read_csv(f, ENCODINGS_TO_TRY)
        if df_raw is None:
            continue
        print(f"ä½¿ç”¨ç·¨ç¢¼: {enc}")
        try:
            df_clean = clean_dataframe(df_raw)
        except Exception as e:
            print(f"âŒ æ¸…ç†å¤±æ•—: {e}")
            continue
        all_dfs.append(df_clean)

    if not all_dfs:
        print("âš ï¸ æ²’æœ‰å¯ç”¨è³‡æ–™")
        return

    combined_df = pd.concat(all_dfs, ignore_index=True).drop_duplicates(subset=['æ—¥æœŸ'])
    combined_df['æ—¥æœŸ'] = pd.to_datetime(combined_df['æ—¥æœŸ'], errors='coerce')
    combined_df = combined_df.dropna(subset=['æ—¥æœŸ']).sort_values(by='æ—¥æœŸ').reset_index(drop=True)
    print(f"è³‡æ–™ç¯„åœ: {combined_df['æ—¥æœŸ'].min()} ~ {combined_df['æ—¥æœŸ'].max()} å…± {len(combined_df)} ç­†")

    # è¨ˆç®— MA
    combined_df['MA5'] = combined_df['æ”¶ç›¤åƒ¹'].rolling(5, min_periods=1).mean().round(2)
    combined_df['MA10'] = combined_df['æ”¶ç›¤åƒ¹'].rolling(10, min_periods=1).mean().round(2)
    combined_df['MA20'] = combined_df['æ”¶ç›¤åƒ¹'].rolling(20, min_periods=1).mean().round(2)

    # è¼¸å‡º CSV
    combined_df['æ—¥æœŸ_str'] = combined_df['æ—¥æœŸ'].dt.strftime('%Y/%m/%d')
    combined_df.to_csv(OUTPUT_PATH, index=False, encoding='big5', columns=['æ—¥æœŸ_str']+PRICE_COLS+['MA5','MA10','MA20'])
    print(f"âœ… å·²è¼¸å‡º CSV: {OUTPUT_PATH}")

    # ç¹ªåœ–
    latest_date = combined_df['æ—¥æœŸ'].max()
    df_plot_full = combined_df[combined_df['æ—¥æœŸ'] >= latest_date - timedelta(days=90)].copy()
    if df_plot_full.empty:
        print("âš ï¸ è³‡æ–™ä¸è¶³ä»¥ç¹ªåœ–")
        return

    # é¡¯ç¤ºå‰ 60 å¤©
    df_plot = df_plot_full.tail(60)
    df_plot = df_plot.rename(columns={'é–‹ç›¤åƒ¹':'Open','æœ€é«˜åƒ¹':'High','æœ€ä½åƒ¹':'Low','æ”¶ç›¤åƒ¹':'Close'}).set_index('æ—¥æœŸ')

    # K ç·šæ¨£å¼
    mc = mpf.make_marketcolors(up='r', down='g', edge='inherit', wick='inherit', inherit=True)
    style = mpf.make_mpf_style(base_mpf_style='yahoo', marketcolors=mc)
    mav = [5,10,20]
    mavcolors = ['purple','darkgreen','gold']
    title = f"{STOCK_CODE} ({STOCK_NAME}) è¿‘ 90 å¤© K ç·š ({df_plot.index.min().date()}~{df_plot.index.max().date()})"

    try:
        fig, axlist = mpf.plot(df_plot, type='candle', mav=mav, mavcolors=mavcolors, volume=False,
                               style=style, title=title, ylabel='åƒ¹æ ¼ (TWD)', figscale=1.5, returnfig=True)
    except TypeError:
        fig, axlist = mpf.plot(df_plot, type='candle', mav=mav, volume=False, style=style,
                               title=title, ylabel='åƒ¹æ ¼ (TWD)', figscale=1.5, returnfig=True)
        main_ax = axlist[0] if isinstance(axlist, list) else axlist
        add_ma_lines_and_legend(main_ax, df_plot, {'MA5':'purple','MA10':'darkgreen','MA20':'gold'})

    # å­—é«”è¨­å®š
    plt.rcParams['font.sans-serif'] = ['Microsoft JhengHei','Microsoft YaHei','DejaVu Sans']

    # åœ–æª”å­˜æª”
    chart_path = OUTPUT_DIR / f"{STOCK_CODE}_KLine_MA_Combined.png"
    fig.savefig(chart_path)
    print(f"ğŸ“ˆ åœ–è¡¨å·²å„²å­˜: {chart_path}")
    plt.show()
    print("\nğŸ‰ å®Œæˆï¼")

if __name__ == '__main__':
    main()
