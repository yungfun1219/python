import pandas as pd
from datetime import datetime
import pathlib
from typing import Optional

# --- æª”æ¡ˆèˆ‡è·¯å¾‘è¨­å®š ---

# å‡è¨­æ‚¨çš„ç¨‹å¼ç¢¼è·¯å¾‘åœ¨ D:\Python_repo\python\Jason_Stock_Analyzer
BASE_DIR = pathlib.Path(r"D:\Python_repo\python\Jason_Stock_Analyzer")

# è¼¸å…¥æª”æ¡ˆè·¯å¾‘ï¼šä½¿ç”¨æ‚¨ç”Ÿæˆçš„å¤šå¹´ä»½äº¤æ˜“æ—¥æª”æ¡ˆ
TRADING_DAY_PATH = BASE_DIR / "datas" / "processed" / "get_holidays" / "trading_day_2021-2025.csv"

def find_latest_past_working_day(file_path: pathlib.Path) -> Optional[str]:
    """
    å¾äº¤æ˜“æ—¥æ¸…å–®ä¸­ï¼Œæ‰¾å‡ºé›¢ä»Šå¤©æœ€è¿‘çš„ä¸€å€‹éå»çš„å·¥ä½œæ—¥ã€‚

    Args:
        file_path: äº¤æ˜“æ—¥æ¸…å–® CSV æª”æ¡ˆçš„è·¯å¾‘ã€‚

    Returns:
        æœ€è¿‘çš„ä¸€å€‹å·¥ä½œæ—¥ (YYYYMMDD æ ¼å¼å­—ä¸²)ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡è¿”å› Noneã€‚
    """
    print(f"--- æ­£åœ¨æŸ¥æ‰¾ {file_path.name} ä¸­çš„æœ€è¿‘å·¥ä½œæ—¥ ---")

    # 1. è®€å–äº¤æ˜“æ—¥æ¸…å–®
    try:
        df = pd.read_csv(file_path, encoding='utf-8-sig')
        
        # ç¢ºä¿æ—¥æœŸæ¬„ä½åç¨±æ­£ç¢º (å‡è¨­æ˜¯ 'Trading_day')
        if 'Trading_day' not in df.columns:
            print("âŒ éŒ¯èª¤ï¼šCSV æª”æ¡ˆä¸­æ‰¾ä¸åˆ° 'Trading_day' æ¬„ä½ã€‚")
            return None
            
        # å°‡æ—¥æœŸè½‰æ›ç‚ºå­—ä¸²ä¸¦å»é™¤ç©ºç™½
        all_trading_days = df['Trading_day'].astype(str).str.strip().tolist()
        
    except FileNotFoundError:
        print(f"âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°äº¤æ˜“æ—¥æª”æ¡ˆï¼š{file_path}")
        return None
    except Exception as e:
        print(f"âŒ éŒ¯èª¤ï¼šè®€å–äº¤æ˜“æ—¥æª”æ¡ˆæ™‚ç™¼ç”Ÿå•é¡Œï¼š{e}")
        return None

    # 2. ç¢ºå®šä»Šå¤©çš„æ—¥æœŸ (YYYYMMDD æ ¼å¼å­—ä¸²)
    today_str = "20250201"#datetime.now().strftime('%Y%m%d')
    print(f"ã€ä»Šå¤©æ—¥æœŸã€‘: {today_str}")

    # 3. ç¯©é¸å‡ºæ‰€æœ‰åœ¨ä»Šå¤©ä¹‹å‰çš„äº¤æ˜“æ—¥
    # ç”±æ–¼æ—¥æœŸéƒ½æ˜¯ YYYYMMDD æ ¼å¼çš„å­—ä¸²ï¼Œå¯ä»¥ç›´æ¥ç”¨å­—ä¸²æ¯”è¼ƒ
    past_working_days = [
        date_str 
        for date_str in all_trading_days 
        if date_str < today_str
    ]

    # 4. æ‰¾å‡ºæœ€å¤§çš„æ—¥æœŸï¼ˆå³é›¢ä»Šå¤©æœ€è¿‘çš„æ—¥æœŸï¼‰
    if not past_working_days:
        print("âš ï¸ è­¦å‘Šï¼šåœ¨æ¸…å–®ä¸­æ‰¾ä¸åˆ°ä»»ä½•éå»çš„å·¥ä½œæ—¥ã€‚")
        return None
    
    # å°éå»çš„å·¥ä½œæ—¥é€²è¡Œæ’åºï¼Œå–æœ€å¾Œä¸€å€‹ (æœ€å¤§çš„é‚£å€‹)
    latest_working_day = max(past_working_days)
    
    return latest_working_day


# --- åŸ·è¡Œç¯„ä¾‹ ---
if __name__ == "__main__":
    
    # æª¢æŸ¥æª”æ¡ˆè·¯å¾‘æ˜¯å¦å­˜åœ¨
    if not TRADING_DAY_PATH.exists():
        print(f"\nè‡´å‘½éŒ¯èª¤ï¼šè«‹å…ˆåŸ·è¡Œä¸Šä¸€å€‹ç¨‹å¼ç¢¼ï¼Œç”Ÿæˆäº¤æ˜“æ—¥æ¸…å–®æ–¼ï¼š\n{TRADING_DAY_PATH}")
    else:
        latest_day = find_latest_past_working_day(TRADING_DAY_PATH)
        
        print("\n=============================================")
        if latest_day:
            print(f"ğŸŸ¢ é›¢ä»Šå¤©æœ€è¿‘çš„ä¸€å€‹éå»å·¥ä½œæ—¥æ˜¯ï¼šã€{latest_day}ã€‘")
        else:
            print("ğŸ”´ ç„¡æ³•ç¢ºå®šæœ€è¿‘çš„å·¥ä½œæ—¥ã€‚")
        print("=============================================")